<div class="importDatabase absolute-fill flex-vertical sql-migration">
    <div class="panel" data-bind="if: inFirstStep, visible: inFirstStep">
        <div class="panel-body">
            <form class="flex-form" data-bind="submit: nextStep">
                <h3>Import documents from a SQL database into the current RavenDB database</h3>
                <div class="row">
                    <div class="col-sm-8 col-lg-6 margin-top" data-bind="with: model">
                        <div class="form-group">
                            <div>
                                <label class="control-label">SQL database driver</label>
                            </div>
                            <div class="flex-grow">
                                <button class="btn btn-block dropdown-toggle text-left" data-toggle="dropdown">
                                    <span data-bind="text: labelForProvider(databaseType())"></span>
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" data-bind="foreach: $data.constructor.possibleProviders">
                                    <li><a href="#"
                                           data-bind="text: $parent.labelForProvider($data), click: $parent.databaseType.bind($parent.databaseType, $data)"></a>
                                    </li>
                                </ul>
                                <span class="help-block" data-bind="validationMessage: databaseType"></span>
                            </div>
                        </div>
                        <div data-bind="visible: databaseType() === 'MsSQL', with: sqlServer">
                            <div class="form-group"
                                 data-bind="validationElement: connectionString">
                                <label class="control-label">Connection string<i class="required"></i></label>
                                <div class="flex-grow">
                                    <textarea class="form-control"
                                              data-bind="textInput: connectionString" rows="3"
                                              title="The connection string for the SQL server"
                                              placeholder="Enter the complete connection string for the SQL server">                                        
                                    </textarea>
                                    <div>
                                        <small>
                                            <i class="icon-info"></i>
                                            Please provide 'Database name' in the field below, instead of using <code>Initial Catalog</code> option. 
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div data-bind="visible: databaseType() === 'MySQL', with: mySql">
                            <div class="form-group" data-bind="validationElement: server">
                                <label class="control-label">Server location<i class="required"></i></label>
                                <div class="flex-grow">
                                    <input class="form-control"
                                           data-bind="textInput: server"
                                           placeholder="Server location">
                                </div>
                            </div>
                            <div class="form-group" data-bind="validationElement: username,">
                                <label class="control-label">Username<i class="required"></i></label>
                                <div class="flex-grow">
                                    <input class="form-control"
                                           data-bind="textInput: username"
                                           placeholder="Username">
                                </div>
                            </div>
                            <div class="form-group" data-bind="validationElement: password">
                                <label class="control-label">Password</label>
                                <div class="flex-grow">
                                    <input type="password" class="form-control"
                                           data-bind="textInput: password"
                                           placeholder="Password">
                                </div>
                            </div>
                        </div>
                        <div class="form-group" data-bind="validationElement: sourceDatabaseName">
                            <label class="control-label">SQL Database name<i class="required"></i></label>
                            <div class="flex-grow">
                                <input class="form-control"
                                       data-bind="textInput: sourceDatabaseName"
                                       placeholder="Enter the SQL Database name">
                            </div>
                        </div>
                    </div>
                </div>
                <hr/>
                <div class="alert alert-warning">
                    If user goes back to this view offer an option to continue previous setup
                </div>
                <hr/>
                <div class="form-group">
                    <div class="col-sm-10">
                        <button class="btn btn-primary" type="submit" 
                                data-bind="disable: $root.spinners.schema, css: { 'btn-spinner': $root.spinners.schema }">
                            <span class="icon-import"></span> <span>Continue</span>
                        </button>
                    </div>
                </div>
            </form>
            
        </div>
    </div>
    
    <div class="row flex-row flex-grow flex-stretch-items" id="js-second-step" data-bind="if: !inFirstStep()">
        <div class="col-sm-12 col-lg-8 flex-vertical">
            <div class="flex-header flex-horizontal">
                <div class="panel panel-default flex-grow no-margin">
                    <div class="panel-body">
                        <button class="btn btn-primary" data-bind="click: $root.migrate">Migrate</button>
                    </div>
                </div>
            </div>
            <div class="scroll flex-grow">
                <div data-bind="foreach: $root.currentTables">
                    <div class="panel panel-info">
                        <div class="flex-horizontal padding padding-sm">
                            <div>
                                <div class="checkbox" data-placement="left">
                                    <input type="checkbox" data-bind="checked: checked, attr: { id: 'table_' + $index() }" />
                                    <label data-bind="attr: { for: 'table_' + $index() }">
                                        <span class="with-top-label" data-label="Table" data-bind="text: tableName"></span>
                                        <i class="icon-arrow-right"></i>
                                        <span class="with-top-label raven-property-name inline-edit" data-label="Collection" data-bind="text: collectionName"></span>
                                    </label>
                                </div>
                                
                            </div>
                            <div class="flex-separator"></div>
                            <div>
                                <button class="btn btn-default">
                                    <i class="icon-edit"></i>
                                    <span>Filter / Transform</span>
                                </button>
                            </div>
                            
                        </div>
                        <div class="panel-addon" data-bind="collapse: checked">
                            <div class="document-id">
                                <span class="text-muted"><i class="icon-sql-document-id"></i> Document ID:</span> 
                                <span data-bind="text: documentIdTemplate"></span>
                            </div>
                            <div class="object-container" data-bind="template: { name: 'object-template' }">
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="panel panel-default no-margin" data-bind="visible: $root.pageCount() > 1">
                <div class="panel-body flex-horizontal">
                    <div>Page <span data-bind="text: $root.currentPage() + 1"></span> <span data-bind="text: '(' + $root.currentLocationHumane() + ')'"></span></div>
                    <div data-bind="foreach: _.range(0, $root.pageCount())">
                        <button class="btn btn-sm" data-bind="text: $data + 1, click: _.partial($root.setCurrentPage, $data), css: { 'active': $root.currentPage() === $data }"></button>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="col-sm-12 col-lg-4 flex-vertical">
            TODO: edit patch / query / test documents
        </div>
    </div>
</div>

<script type="text/html" id="object-template">
    <table data-bind="foreach:documentColumns" class="properties_table">
        <tr>
            <td><span data-bind="text: sqlName"></span></td>
            <td><i class="icon-arrow-right"></i></td>
            <td class="inline-edit"><span class="raven-property-name" data-bind="text: propertyName"></span> <span class="text-muted" data-bind="text: ': ' + type"></span></td>
        </tr>
    </table>
    
    <table data-bind="foreach: references" style="width:100%">
        <tr>
            <td width="400">
                <span data-bind="visible: type === 'OneToMany'">
                    <span class="text-muted">PK</span>
                    <span data-bind="text: $parent.getPrimaryKeyColumnNames().join(',')"></span>
                    
                    <i data-bind="attr: { class: getTypeClass(), title: 'Relation type: ' + type }"></i>
                    
                    <span class="text-muted">from FK</span>
                    <span data-bind="text: joinColumns.join(', ')"></span>
                    <span class="text-muted">in <i class="icon-table"></i></span>
                    <span data-bind="text: targetTable.tableName"></span>
                </span>
                
                <span data-bind="visible: type === 'ManyToOne'">
                    <span class="text-muted">FK</span> 
                    <span data-bind="text: joinColumns.join(', ')"></span> 
                    <i data-bind="attr: { class: getTypeClass(), title: 'Relation type: ' + type }"></i>
                    
                    <span class="text-muted">from PK</span>
                    <span data-bind="text: targetTable.getPrimaryKeyColumnNames().join(',')"></span>
                    <span class="text-muted">in <i class="icon-table"></i></span>
                    <span data-bind="text: targetTable.tableName"></span>
                </span>
            </td>
            <td width="180">
                <div class="btn-group link-actions">
                    <button class="btn btn-sm" data-bind="css: { active: action() === 'skip' }, click: _.partial($root.onActionClicked, $data, 'skip')">skip</button>
                    <button class="btn btn-sm" data-bind="css: { active: action() === 'link' }, click: _.partial($root.onActionClicked, $data, 'link')">link</button>
                    <button class="btn btn-sm" data-bind="css: { active: action() === 'embed' }, click: _.partial($root.onActionClicked, $data, 'embed')">embed</button>
                </div>
                <span data-bind="visible: effectiveInnerTable() || effectiveLinkTable()">
                    <i class="icon-arrow-right"></i>
                </span>
            </td>
            <td>
                <span class="inline-edit" data-bind="with: effectiveInnerTable">
                    <span class="raven-property-name" data-bind="text: $parent.name"></span>:
                </span>
                <span class="inline-edit" data-bind="with: effectiveLinkTable">
                    <span class="raven-property-name" data-bind="text: $parent.name"></span>:
                    <span class="text-muted" data-bind="visible: $parent.type === 'ManyToOne'">[</span>
                    <span data-bind="text: documentIdTemplate"></span>
                    <span class="text-muted" data-bind="visible: $parent.type === 'ManyToOne'">, ...]</span>
                </span>
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <div data-bind="with: effectiveInnerTable">
                    <div data-bind="css: { 'array-container': $parent.type === 'OneToMany'}">
                        <div class="object-container" data-bind="template: { name: 'object-template' }">
                        </div>    
                    </div>
                </div>
            </td>
        </tr>
    </table>
</script>
