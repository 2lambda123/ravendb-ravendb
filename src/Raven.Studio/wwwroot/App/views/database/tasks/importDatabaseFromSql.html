<div class="importDatabase absolute-fill flex-vertical sql-migration">
    <div class="panel" data-bind="if: inFirstStep, visible: inFirstStep">
        <div class="panel-body">
            <form class="flex-form" data-bind="submit: nextStep">
                <h3>Import documents from a SQL database into the current RavenDB database</h3>
                <div class="row">
                    <div class="col-sm-8 col-lg-6 margin-top" data-bind="with: model">
                        <div class="form-group">
                            <div>
                                <label class="control-label">SQL database driver</label>
                            </div>
                            <div class="flex-grow">
                                <button class="btn btn-block dropdown-toggle text-left" data-toggle="dropdown">
                                    <span data-bind="text: labelForProvider(databaseType())"></span>
                                    <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" data-bind="foreach: $data.constructor.possibleProviders">
                                    <li><a href="#"
                                           data-bind="text: $parent.labelForProvider($data), click: $parent.databaseType.bind($parent.databaseType, $data)"></a>
                                    </li>
                                </ul>
                                <span class="help-block" data-bind="validationMessage: databaseType"></span>
                            </div>
                        </div>
                        <div data-bind="visible: databaseType() === 'MsSQL', with: sqlServer">
                            <div class="form-group"
                                 data-bind="validationElement: connectionString">
                                <label class="control-label">Connection string<i class="required"></i></label>
                                <div class="flex-grow">
                                    <textarea class="form-control"
                                              data-bind="textInput: connectionString" rows="3"
                                              title="The connection string for the SQL server"
                                              placeholder="Enter the complete connection string for the SQL server">                                        
                                    </textarea>
                                    <div>
                                        <small>
                                            <i class="icon-info"></i>
                                            Please provide 'Database name' in the field below, instead of using <code>Initial Catalog</code> option. 
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div data-bind="visible: databaseType() === 'MySQL', with: mySql">
                            <div class="form-group" data-bind="validationElement: server">
                                <label class="control-label">Server location<i class="required"></i></label>
                                <div class="flex-grow">
                                    <input class="form-control"
                                           data-bind="textInput: server"
                                           placeholder="Server location">
                                </div>
                            </div>
                            <div class="form-group" data-bind="validationElement: username,">
                                <label class="control-label">Username<i class="required"></i></label>
                                <div class="flex-grow">
                                    <input class="form-control"
                                           data-bind="textInput: username"
                                           placeholder="Username">
                                </div>
                            </div>
                            <div class="form-group" data-bind="validationElement: password">
                                <label class="control-label">Password</label>
                                <div class="flex-grow">
                                    <input type="password" class="form-control"
                                           data-bind="textInput: password"
                                           placeholder="Password">
                                </div>
                            </div>
                        </div>
                        <div class="form-group" data-bind="validationElement: sourceDatabaseName">
                            <label class="control-label">SQL Database name<i class="required"></i></label>
                            <div class="dropdown btn-block flex-grow"  data-bind="validationOptions: { insertMessages: false }">
                                <input class="form-control" autocomplete="off" id="sqlDatabaseName"
                                       data-bind="textInput: sourceDatabaseName, hasFocus: $root.sourceDatabaseFocus"
                                       placeholder="Enter the SQL Database name">
                                <span class="caret dropdown-toggle" data-toggle="dropdown"></span>
                                <ul class="dropdown-menu max-height" role="menu" style="display: none;"
                                    data-bind="autoComplete: '#sqlDatabaseName', foreach: $root.createDbAutocompleter(sourceDatabaseName)">
                                    <li role="presentation" data-bind="click: $parent.sourceDatabaseName.bind($parent, $data)">
                                        <a role="menuitem" tabindex="-1" href="#">
                                            <span data-bind="text: $data"></span>
                                        </a>
                                    </li>
                                </ul>
                                <div data-bind="validationOptions: { errorsAsTitle: false }, validationElement: sourceDatabaseName">
                                    <div class="help-block" data-bind="validationMessage: sourceDatabaseName"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div data-bind="collapse: $root.showAdvancedOptions">
                            <hr />
                            <h3>Advanced options</h3>
                            <div class="form-group">
                                <label class="control-label">&nbsp;</label>
                                <div class="toggle">
                                    <input id="pascalCase" type="checkbox" data-bind="checked: advanced.usePascalCase">
                                    <label for="pascalCase">Convert property names to <strong>PascalCase</strong></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label">&nbsp;</label>
                                <div class="toggle">
                                    <input id="removeId" type="checkbox" data-bind="checked: advanced.trimUnderscoreId">
                                    <label for="removeId">Trim <strong>_id</strong> from property names</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label">&nbsp;</label>
                                <div class="toggle">
                                    <input id="manyToMany" type="checkbox" data-bind="checked: advanced.usePascalCase">
                                    <label for="manyToMany">Detect <strong>many-to-many</strong> relationships</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr/>
                <div class="alert alert-warning">
                    If user goes back to this view offer an option to continue previous setup
                </div>
                <hr/>
                <div class="form-group">
                    <div class="col-sm-10">
                        <button class="btn btn-default" type="button" data-bind="click: $root.showAdvancedOptions.toggle.bind($root.showAdvancedOptions)">
                            Advanced
                        </button>
                        <button class="btn btn-primary" type="submit" 
                                data-bind="disable: $root.spinners.schema, css: { 'btn-spinner': $root.spinners.schema }">
                            <span class="icon-import"></span> <span>Continue</span>
                        </button>
                    </div>
                </div>
            </form>
            
        </div>
    </div>
    
    <div class="row flex-row flex-grow flex-stretch-items" id="js-second-step" data-bind="if: !inFirstStep()">
        <div class="col-sm-12 col-lg-8 flex-vertical">
            <div class="flex-header flex-horizontal">
                <div class="panel panel-default flex-grow no-margin">
                    <div class="panel-body padding padding-sm flex-horizontal">
                        <div class="checkbox checkbox-default checkbox-inline align-checkboxes" title="Select all or none">
                            <input type="checkbox" class="styled" data-bind="checkboxTriple: globalSelectionState, event: { change: toggleSelectAll }" />
                            <label></label>
                        </div>
                        
                        <button class="btn btn-primary" data-bind="click: $root.migrate, disable: $root.spinners.importing, css: { 'btn-spinner': $root.spinners.importing }">
                            <i class="icon-import"></i>
                            <span>Migrate selected tables </span><span data-bind="visible: model.testImport">(partial)</span>
                        </button>
                        <div class="flex-separator"></div>
                        <div class="dropdown">
                            <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                <i class="icon-settings"></i><span>Settings</span>
                                <span class="caret"></span>
                            </button>
                            <div class="dropdown-menu settings-menu dropdown-menu-right" data-bind="dropdownPanel: true, template: { name: 'migration-settings-template' }">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="scroll flex-grow js-scroll-tables">
                <div data-bind="foreach: $root.currentTables">
                    <div class="panel panel-info js-root-table-panel">
                        <div class="flex-horizontal padding padding-sm panel-header">
                            <div class="checkbox" data-placement="left">
                                <input type="checkbox" data-bind="click: $root.onCollapseTable, checked: checked, attr: { id: 'table_' + $index() }" />
                                <label data-bind="attr: { for: 'table_' + $index() }">&nbsp;</label>
                            </div>
                            <div class="flex-horizontal flex-wrap">
                                <span class="with-top-label js-sql-table-name" data-label="Table" data-bind="text: tableName"></span>
                                <i class="icon-arrow-right"></i>
                                <div class="with-top-label raven-property-name inline-edit inline-block" data-label="Collection">
                                    <span class="static" data-bind="text: collectionName"></span>
                                    <input class="form-control input-sm" data-bind="textInput: collectionName" />
                                </div>    
                            </div>
                            <div class="flex-separator"></div>
                            <div>
                                <button class="btn btn-default" data-bind="click: $root.enterEditMode, css: { active: $data === $root.itemBeingEdited() }">
                                    <i class="icon-edit"></i>
                                    <span>Filter / Transform</span>
                                </button>
                            </div>
                            
                        </div>
                        <div class="panel-addon" data-bind="collapse: checked">
                            <div class="document-id">
                                <span class="text-muted"><i class="icon-sql-document-id"></i> Document ID:</span> 
                                <span data-bind="text: documentIdTemplate"></span>
                            </div>
                            <div class="object-container" data-bind="template: { name: 'object-template' }">
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="panel panel-default no-margin" data-bind="visible: $root.pageCount() > 1">
                <div class="panel-body flex-horizontal">
                    <div>Page <span data-bind="text: $root.currentPage() + 1"></span> <span data-bind="text: '(' + $root.currentLocationHumane() + ')'"></span></div>
                    <div data-bind="foreach: _.range(0, $root.pageCount())">
                        <button class="btn btn-sm" data-bind="text: $data + 1, click: _.partial($root.setCurrentPage, $data), css: { 'active': $root.currentPage() === $data }"></button>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="col-sm-12 col-lg-4 flex-vertical">
            <div id="editTransform" class="panel" data-bind="with: itemBeingEdited">
                <div class="padding padding-sm">
                    <div>
                        <label>
                            <strong>SQL Table:</strong> <span data-bind="text: tableName"></span>
                        </label>
                    </div>
                    
                    <div class="toggle">
                        <input id="customizeQuery" type="checkbox" data-bind="checked: customizeQuery">
                        <label for="customizeQuery">Filter source table records</label>
                    </div>
                    
                    <div data-bind="collapse: customizeQuery">
                        <label><strong>SQL Query:</strong></label>
                        <div data-bind="validationElement: query">
                            <pre class="form-control editor"
                                 data-bind="aceEditor: { code: query, fontSize: '14px', lang: $root.aceEditorLangMode(), completer: $root.completer }, validationOptions: { errorsAsTitle: false }, validationElement: query" style="height: 200px;"></pre>
    
                            <div data-bind="validationOptions: { errorsAsTitle: false }, validationElement: query">
                                <div class="help-block" data-bind="validationMessage: query"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="toggle">
                        <input id="transformResults" type="checkbox" data-bind="checked: transformResults">
                        <label for="transformResults">Transform documents</label>
                    </div>
                    
                    <div data-bind="collapse: transformResults">
                        <label><strong>Script:</strong></label>
                        <span class="pull-right"><a href="#" data-bind="click: $root.syntaxHelp"><small>Syntax help</small></a></span>
                        <div data-bind="validationElement: patchScript">
                            <pre class="form-control editor"
                                 data-bind="aceEditor: { code: patchScript, fontSize: '14px', lang: 'ace/mode/javascript' }, validationOptions: { errorsAsTitle: false }, validationElement: patchScript" style="height: 300px;"></pre>
    
                            <div data-bind="validationOptions: { errorsAsTitle: false }, validationElement: patchScript">
                                <div class="help-block" data-bind="validationMessage: patchScript"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="margin-top">
                        <button title="Close" class="btn btn-default" data-bind="click: $root.closeEditedTransformation"><i class="icon-cancel"></i> <span>Close</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/html" id="object-template">
    <table class="properties_table">
        <tbody data-bind="foreach:documentColumns">
            <tr>
                <td><span data-bind="text: sqlName"></span></td>
                <td><i class="icon-arrow-right"></i></td>
                <td class="inline-edit">
                    <div class="static">
                        <span class="raven-property-name" data-bind="text: propertyName"></span> <span class="text-muted" data-bind="text: ': ' + type"></span>
                    </div>
                    <input class="form-control input-sm" data-bind="textInput: propertyName" />
                </td>
            </tr>
        </tbody>
    </table>
    
    <table style="width:100%">
        <tbody data-bind="foreach: references">
            <tr>
                <td width="400">
                    <span data-bind="visible: type === 'OneToMany'">
                        <span class="text-muted">PK</span>
                        <span data-bind="text: $parent.getPrimaryKeyColumnNames().join(',')"></span>
                        
                        <i data-bind="attr: { class: getTypeClass(), title: 'Relation type: ' + type }"></i>
                        
                        <span class="text-muted">from FK</span>
                        <span data-bind="text: joinColumns.join(', ')"></span>
                        <span class="text-muted">in <i class="icon-table"></i></span>
                        <a href="#" data-bind="text: targetTable.tableName, attr: { title: 'Navigate to ' + targetTable.tableName + ' table'}, click: _.partial($root.goToTable, targetTable)"></a>
                    </span>
                    
                    <span data-bind="visible: type === 'ManyToOne'">
                        <span class="text-muted">FK</span> 
                        <span data-bind="text: joinColumns.join(', ')"></span> 
                        <i data-bind="attr: { class: getTypeClass(), title: 'Relation type: ' + type }"></i>
                        
                        <span class="text-muted">from PK</span>
                        <span data-bind="text: targetTable.getPrimaryKeyColumnNames().join(',')"></span>
                        <span class="text-muted">in <i class="icon-table"></i></span>
                        <a href="#" data-bind="text: targetTable.tableName, attr: { title: 'Navigate to ' + targetTable.tableName + ' table'}, click: _.partial($root.goToTable, targetTable)"></a>
                    </span>
                </td>
                <td width="180">
                    <div class="btn-group link-actions">
                        <button class="btn btn-sm" data-bind="css: { active: action() === 'skip' }, click: _.partial($root.onActionClicked, $data, 'skip')">skip</button>
                        <button class="btn btn-sm" data-bind="css: { active: action() === 'link' }, click: _.partial($root.onActionClicked, $data, 'link')">link</button>
                        <button class="btn btn-sm" data-bind="css: { active: action() === 'embed' }, click: _.partial($root.onActionClicked, $data, 'embed')">embed</button>
                    </div>
                    <span data-bind="visible: effectiveInnerTable() || effectiveLinkTable()">
                        <i class="icon-arrow-right"></i>
                    </span>
                </td>
                <td>
                    <div class="inline-edit inline-block" data-bind="with: effectiveInnerTable">
                        <span class="static">
                            <span class="raven-property-name" data-bind="text: $parent.name"></span>:
                        </span>
                        <input class="form-control input-sm" data-bind="textInput: $parent.name" />
                    </div>
                    <div class="inline-edit inline-block" data-bind="with: effectiveLinkTable">
                        <div class="static">
                            <span class="raven-property-name" data-bind="text: $parent.name"></span>:
                            <span class="text-muted" data-bind="visible: $parent.type === 'OneToMany'">[</span>
                            <span data-bind="text: documentIdTemplate"></span>
                            <span class="text-muted" data-bind="visible: $parent.type === 'OneToMany'">, ...]</span>
                        </div>
                        <input class="form-control input-sm" data-bind="textInput: $parent.name" />
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <div data-bind="with: effectiveInnerTable">
                        <div data-bind="css: { 'array-container': $parent.type === 'OneToMany'}">
                            <div class="object-container" data-bind="template: { name: 'object-template' }">
                            </div>    
                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</script>

<script type="text/html" id="migration-settings-template">
    <form class="flex-form padding" data-bind="with: model">
        <div class="form-group" data-bind="validationElement: batchSize">
            <label class="control-label">Batch size</label>
            <div class="flex-grow">
                <input class="form-control" placeholder="Migration batch size" data-bind="numericInput: batchSize">
            </div>
        </div>
        <div class="form-group">
            <label class="control-label">Convert binary columns to attachments</label>
            <div class="flex-grow">
                <div class="toggle">
                    <input type="checkbox" class="styled" data-bind="checked: binaryToAttachment">
                    <label></label>
                </div>
            </div>
        </div>
        <div class="form-group no-margin">
            <label class="control-label">Partial migration <br/><small class="text-muted">limits maximum number of documents<br /> per each table</small></label>
            <div class="flex-grow">
                <div class="toggle">
                    <input type="checkbox" class="styled" data-bind="checked: testImport">
                    <label></label>
                </div>
            </div>
        </div>
        
        <div class="form-group" data-bind="validationElement: maxDocumentsToImportPerTable, visible: testImport">
            <label class="control-label left-ident">Maximum rows number<br /><small class="text-muted">per SQL table</small></label>
            <div class="flex-grow">
                <input class="form-control" placeholder="Migration batch size" data-bind="numericInput: maxDocumentsToImportPerTable">
            </div>
        </div>
        
        <div class="flex-horizontal">
            <div class="flex-separator"></div>
            <button class="btn btn-default btn-sm close-panel">
                Close
            </button>
        </div>
    </form>
</script>
